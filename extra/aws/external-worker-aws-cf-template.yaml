---
AWSTemplateFormatVersion: "2010-09-09"
Description: "Deploy workers pool for Cycloid.io CI Platform.
  Version of Concourse worker is automatically generated by a curl on scheduler_api_address/api/v1/info"
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Cycloid - required"
        Parameters:
          - TeamId
          - WorkerKey
      - Label:
          default: "Worker - required"
        Parameters:
          - KeyName
          - VpcId
          - Subnets
          - SSHSecurityGroup
          - MetricsSecGroup
      - Label:
          default: "On-premises specific (optional on SaaS)"
        Parameters:
          - SchedulerApiAddress
          - SchedulerHost
          - SchedulerPort
          - TsaPublicKey
      - Label:
          default: "Worker (optional)"
        Parameters:
          - NumberOfWorkers
          - InstanceSpotPriceEnabled
          - InstanceType
          - ScheduledWorkersEnabled
          - ScheduledWorkersStartRecurrence
          - ScheduledWorkersStopRecurrence
      - Label:
          default: "Worker advanced (optional)"
        Parameters:
          - WorkerTag
          - WorkerRuntime
          - WorkerDnsDerver
          - VolumeSize
          - InstanceSpotPrice
          - WorkerVersion
      - Label:
          default: "Cycloid advanced (optional)"
        Parameters:
          - OrganizationTag
          - EnvironmentTag
          - RoleTag
          - StackBranch
          - DebugMode

    ParameterLabels:
      VpcId:
        default: "VPC ID: Which VPC should this be deployed to?"
      TeamId:
        default: "Cycloid CI team ID"
      WorkerKey:
        default: "Cycloid CI worker private key, base64 encoded"
      KeyName:
        default: "KeyName: The instance's AWS EC2 SSH key-pair name"
      Subnets:
        default: "Subnets in the selected VPC for AWS EC2 instances"
      SSHSecurityGroup:
        default: "Allow SSH access from the specified security group"
      MetricsSecGroup:
        default: "Allow metrics (tcp/9100) access from the specified security group. If you don't have one, provide the same as SSHSecurityGroup"
      NumberOfWorkers:
        default: "How many Cycloid workers would you like to deploy?"
      InstanceSpotPriceEnabled:
        default: "Spot instances: Would you like to use AWS spot instances?"
      InstanceType:
        default: "Type: Which AWS instance type would you like to use?"
      ScheduledWorkersEnabled:
        default: "Start/Stop: would you like to enable an automatic start/stop of workers?"
      ScheduledWorkersStartRecurrence:
        default: "Start time: when should start the workers ? (if enabled)"
      ScheduledWorkersStopRecurrence:
        default: "Stop time: when should stop the workers ? (if enabled)"
      SchedulerApiAddress:
        default: "Scheduler API url: Cycloid CI scheduler http api address (On-premises)"
      SchedulerHost:
        default: "Scheduler host: Cycloid CI scheduler host address (On-premises)"
      SchedulerPort:
        default: "Scheduler port: Cycloid CI scheduler port (On-premises)"
      TsaPublicKey:
        default: "Scheduler TSA public key: Cycloid CI scheduler public key (On-premises)"
Parameters:
  SchedulerApiAddress:
    Description: This url has to be specified if you are not using Cycloid SaaS console.cycloid.io.
    Type: String
    Default: https://scheduler.cycloid.io
  SchedulerHost:
    Description: This host address has to be specified if you are not using Cycloid SaaS console.cycloid.io.
    Type: String
    Default: scheduler.cycloid.io
  SchedulerPort:
    Description: This port has to be specified if you are not using Cycloid SaaS console.cycloid.io.
    Type: String
    Default: 32223
  NumberOfWorkers:
    Description: Number of Cycloid CI workers.
    Type: Number
    Default: 1
    ConstraintDescription: Maximum number of workers is 1000.
  VolumeSize:
    Description: Size of the EBS volume for Cycloid CI worker
    Type: Number
    Default: 150
  TeamId:
    Description: This parameter can be obtained by clicking on your profile picture in Cycloid console, then organization settings/Metadata under the ci_team_name field.
    Type: String
    MinLength: 1
  TsaPublicKey:
    Description: This scheduler TSA public key has to be specified if you are not using Cycloid SaaS console.cycloid.io. Use to SSH keypair used in concourse_tsa_public_key during on-premises setup.
    Type: String
    Default: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC+To6R1hDAO00Xrt8q5Md38J9dh+aMIbV2GTqQkFcKwVAB6czbPPcitPWZ7y3Bw1dKMC8R7DGRAt01yWlkYo/voRp5prqKMc/uzkObhHNy42eJgZlStKU1IMw/fx0Rx+6Y3NClCCOecx415dkAH+PFudKosq4pFB9KjfOp3tMHqirMSF7dsbM3910gcPBL2NFHkOZ4cNfeSztXEg9wy4SExX3CHiUyLiShpwXa+C2f6IPdOJt+9ueXQIL0hcMmd12PRL5UU6/e5U5kldM4EWiJoohVbfoA1CRFF9QwJt6H3IiZPmd3sWqIVVy6Vssn5okjYLRwCwEd8+wd8tI6OnNb"
  WorkerKey:
    Description: You can obtain this key on Cycloid console, under security/credentials section. Looking of a credential named Cycloid-worker-keys, use a base64 encoded version of the the ssh_prv field
    Type: String
    MinLength: 1
  WorkerRuntime:
    Description: Specify the default worker container runtimes https://concourse-ci.org/concourse-worker.html#configuring-runtimes
    Type: String
    Default: ""
  WorkerTag:
    Description: Specify a TAG for worker https://concourse-ci.org/concourse-worker.html#tags-and-team-workers
    Type: String
    Default: ""
  WorkerDnsDerver:
    Description: "Override DNS server or add additionals one depending of the worker runtime specified. ex '1.1.1.1,8.8.8.8'"
    Type: String
    Default: ""
  InstanceType:
    Description: AWS EC2 instance type used for Cycloid worker
    Type: String
    Default: c5d.xlarge
    # aws ec2 describe-instance-types | jq -r '.InstanceTypes[] | "      - \(.InstanceType)"' | sort
    AllowedValues:
      - a1.2xlarge
      - a1.4xlarge
      - a1.large
      - a1.medium
      - a1.metal
      - a1.xlarge
      - c1.medium
      - c1.xlarge
      - c3.2xlarge
      - c3.4xlarge
      - c3.8xlarge
      - c3.large
      - c3.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c4.8xlarge
      - c4.large
      - c4.xlarge
      - c5.12xlarge
      - c5.18xlarge
      - c5.24xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5.9xlarge
      - c5a.12xlarge
      - c5a.16xlarge
      - c5a.24xlarge
      - c5a.2xlarge
      - c5a.4xlarge
      - c5a.8xlarge
      - c5ad.12xlarge
      - c5ad.16xlarge
      - c5ad.24xlarge
      - c5ad.2xlarge
      - c5ad.4xlarge
      - c5ad.8xlarge
      - c5ad.large
      - c5ad.xlarge
      - c5a.large
      - c5a.xlarge
      - c5d.12xlarge
      - c5d.18xlarge
      - c5d.24xlarge
      - c5d.2xlarge
      - c5d.4xlarge
      - c5d.9xlarge
      - c5d.large
      - c5d.metal
      - c5d.xlarge
      - c5.large
      - c5.metal
      - c5n.18xlarge
      - c5n.2xlarge
      - c5n.4xlarge
      - c5n.9xlarge
      - c5n.large
      - c5n.metal
      - c5n.xlarge
      - c5.xlarge
      - c6a.12xlarge
      - c6a.16xlarge
      - c6a.24xlarge
      - c6a.2xlarge
      - c6a.32xlarge
      - c6a.48xlarge
      - c6a.4xlarge
      - c6a.8xlarge
      - c6a.large
      - c6a.metal
      - c6a.xlarge
      - c6g.12xlarge
      - c6g.16xlarge
      - c6g.2xlarge
      - c6g.4xlarge
      - c6g.8xlarge
      - c6gd.12xlarge
      - c6gd.16xlarge
      - c6gd.2xlarge
      - c6gd.4xlarge
      - c6gd.8xlarge
      - c6gd.large
      - c6gd.medium
      - c6gd.metal
      - c6gd.xlarge
      - c6g.large
      - c6g.medium
      - c6g.metal
      - c6gn.12xlarge
      - c6gn.16xlarge
      - c6gn.2xlarge
      - c6gn.4xlarge
      - c6gn.8xlarge
      - c6gn.large
      - c6gn.medium
      - c6gn.xlarge
      - c6g.xlarge
      - c6i.12xlarge
      - c6i.16xlarge
      - c6i.24xlarge
      - c6i.2xlarge
      - c6i.32xlarge
      - c6i.4xlarge
      - c6i.8xlarge
      - c6id.12xlarge
      - c6id.16xlarge
      - c6id.24xlarge
      - c6id.2xlarge
      - c6id.32xlarge
      - c6id.4xlarge
      - c6id.8xlarge
      - c6id.large
      - c6id.metal
      - c6id.xlarge
      - c6i.large
      - c6i.metal
      - c6in.12xlarge
      - c6in.16xlarge
      - c6in.24xlarge
      - c6in.2xlarge
      - c6in.32xlarge
      - c6in.4xlarge
      - c6in.8xlarge
      - c6in.large
      - c6in.metal
      - c6in.xlarge
      - c6i.xlarge
      - c7a.12xlarge
      - c7a.16xlarge
      - c7a.24xlarge
      - c7a.2xlarge
      - c7a.32xlarge
      - c7a.48xlarge
      - c7a.4xlarge
      - c7a.8xlarge
      - c7a.large
      - c7a.medium
      - c7a.metal-48xl
      - c7a.xlarge
      - c7g.12xlarge
      - c7g.16xlarge
      - c7g.2xlarge
      - c7g.4xlarge
      - c7g.8xlarge
      - c7gd.12xlarge
      - c7gd.16xlarge
      - c7gd.2xlarge
      - c7gd.4xlarge
      - c7gd.8xlarge
      - c7gd.large
      - c7gd.medium
      - c7gd.metal
      - c7gd.xlarge
      - c7g.large
      - c7g.medium
      - c7g.metal
      - c7gn.12xlarge
      - c7gn.16xlarge
      - c7gn.2xlarge
      - c7gn.4xlarge
      - c7gn.8xlarge
      - c7gn.large
      - c7gn.medium
      - c7gn.metal
      - c7gn.xlarge
      - c7g.xlarge
      - c7i.12xlarge
      - c7i.16xlarge
      - c7i.24xlarge
      - c7i.2xlarge
      - c7i.48xlarge
      - c7i.4xlarge
      - c7i.8xlarge
      - c7i-flex.12xlarge
      - c7i-flex.16xlarge
      - c7i-flex.2xlarge
      - c7i-flex.4xlarge
      - c7i-flex.8xlarge
      - c7i-flex.large
      - c7i-flex.xlarge
      - c7i.large
      - c7i.metal-24xl
      - c7i.metal-48xl
      - c7i.xlarge
      - c8g.12xlarge
      - c8g.16xlarge
      - c8g.24xlarge
      - c8g.2xlarge
      - c8g.48xlarge
      - c8g.4xlarge
      - c8g.8xlarge
      - c8g.large
      - c8g.medium
      - c8g.metal-24xl
      - c8g.metal-48xl
      - c8g.xlarge
      - d2.2xlarge
      - d2.4xlarge
      - d2.8xlarge
      - d2.xlarge
      - d3.2xlarge
      - d3.4xlarge
      - d3.8xlarge
      - d3en.12xlarge
      - d3en.2xlarge
      - d3en.4xlarge
      - d3en.6xlarge
      - d3en.8xlarge
      - d3en.xlarge
      - d3.xlarge
      - f1.16xlarge
      - f1.2xlarge
      - f1.4xlarge
      - g4ad.16xlarge
      - g4ad.2xlarge
      - g4ad.4xlarge
      - g4ad.8xlarge
      - g4ad.xlarge
      - g4dn.12xlarge
      - g4dn.16xlarge
      - g4dn.2xlarge
      - g4dn.4xlarge
      - g4dn.8xlarge
      - g4dn.metal
      - g4dn.xlarge
      - g5.12xlarge
      - g5.16xlarge
      - g5.24xlarge
      - g5.2xlarge
      - g5.48xlarge
      - g5.4xlarge
      - g5.8xlarge
      - g5.xlarge
      - h1.16xlarge
      - h1.2xlarge
      - h1.4xlarge
      - h1.8xlarge
      - hpc7a.12xlarge
      - hpc7a.24xlarge
      - hpc7a.48xlarge
      - hpc7a.96xlarge
      - hpc7g.16xlarge
      - hpc7g.4xlarge
      - hpc7g.8xlarge
      - i2.2xlarge
      - i2.4xlarge
      - i2.8xlarge
      - i2.xlarge
      - i3.16xlarge
      - i3.2xlarge
      - i3.4xlarge
      - i3.8xlarge
      - i3en.12xlarge
      - i3en.24xlarge
      - i3en.2xlarge
      - i3en.3xlarge
      - i3en.6xlarge
      - i3en.large
      - i3en.metal
      - i3en.xlarge
      - i3.large
      - i3.xlarge
      - i4g.16xlarge
      - i4g.2xlarge
      - i4g.4xlarge
      - i4g.8xlarge
      - i4g.large
      - i4g.xlarge
      - i4i.12xlarge
      - i4i.16xlarge
      - i4i.24xlarge
      - i4i.2xlarge
      - i4i.32xlarge
      - i4i.4xlarge
      - i4i.8xlarge
      - i4i.large
      - i4i.metal
      - i4i.xlarge
      - i7ie.12xlarge
      - i7ie.18xlarge
      - i7ie.24xlarge
      - i7ie.2xlarge
      - i7ie.3xlarge
      - i7ie.48xlarge
      - i7ie.6xlarge
      - i7ie.large
      - i7ie.metal-24xl
      - i7ie.metal-48xl
      - i7ie.xlarge
      - i8g.12xlarge
      - i8g.16xlarge
      - i8g.24xlarge
      - i8g.2xlarge
      - i8g.48xlarge
      - i8g.4xlarge
      - i8g.8xlarge
      - i8g.large
      - i8g.metal-24xl
      - i8g.xlarge
      - im4gn.16xlarge
      - im4gn.2xlarge
      - im4gn.4xlarge
      - im4gn.8xlarge
      - im4gn.large
      - im4gn.xlarge
      - inf1.24xlarge
      - inf1.2xlarge
      - inf1.6xlarge
      - inf1.xlarge
      - inf2.24xlarge
      - inf2.48xlarge
      - inf2.8xlarge
      - inf2.xlarge
      - is4gen.2xlarge
      - is4gen.4xlarge
      - is4gen.8xlarge
      - is4gen.large
      - is4gen.medium
      - is4gen.xlarge
      - m1.large
      - m1.medium
      - m1.small
      - m1.xlarge
      - m2.2xlarge
      - m2.4xlarge
      - m2.xlarge
      - m3.2xlarge
      - m3.large
      - m3.medium
      - m3.xlarge
      - m4.10xlarge
      - m4.16xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.large
      - m4.xlarge
      - m5.12xlarge
      - m5.16xlarge
      - m5.24xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5.8xlarge
      - m5a.12xlarge
      - m5a.16xlarge
      - m5a.24xlarge
      - m5a.2xlarge
      - m5a.4xlarge
      - m5a.8xlarge
      - m5ad.12xlarge
      - m5ad.16xlarge
      - m5ad.24xlarge
      - m5ad.2xlarge
      - m5ad.4xlarge
      - m5ad.8xlarge
      - m5ad.large
      - m5ad.xlarge
      - m5a.large
      - m5a.xlarge
      - m5d.12xlarge
      - m5d.16xlarge
      - m5d.24xlarge
      - m5d.2xlarge
      - m5d.4xlarge
      - m5d.8xlarge
      - m5d.large
      - m5d.metal
      - m5dn.12xlarge
      - m5dn.16xlarge
      - m5dn.24xlarge
      - m5dn.2xlarge
      - m5dn.4xlarge
      - m5dn.8xlarge
      - m5dn.large
      - m5dn.metal
      - m5dn.xlarge
      - m5d.xlarge
      - m5.large
      - m5.metal
      - m5n.12xlarge
      - m5n.16xlarge
      - m5n.24xlarge
      - m5n.2xlarge
      - m5n.4xlarge
      - m5n.8xlarge
      - m5n.large
      - m5n.xlarge
      - m5.xlarge
      - m5zn.12xlarge
      - m5zn.2xlarge
      - m5zn.3xlarge
      - m5zn.6xlarge
      - m5zn.large
      - m5zn.metal
      - m5zn.xlarge
      - m6a.12xlarge
      - m6a.16xlarge
      - m6a.24xlarge
      - m6a.2xlarge
      - m6a.32xlarge
      - m6a.48xlarge
      - m6a.4xlarge
      - m6a.8xlarge
      - m6a.large
      - m6a.metal
      - m6a.xlarge
      - m6g.12xlarge
      - m6g.16xlarge
      - m6g.2xlarge
      - m6g.4xlarge
      - m6g.8xlarge
      - m6gd.12xlarge
      - m6gd.16xlarge
      - m6gd.2xlarge
      - m6gd.4xlarge
      - m6gd.8xlarge
      - m6gd.large
      - m6gd.medium
      - m6gd.metal
      - m6gd.xlarge
      - m6g.large
      - m6g.medium
      - m6g.metal
      - m6g.xlarge
      - m6i.12xlarge
      - m6i.16xlarge
      - m6i.24xlarge
      - m6i.2xlarge
      - m6i.32xlarge
      - m6i.4xlarge
      - m6i.8xlarge
      - m6id.12xlarge
      - m6id.16xlarge
      - m6id.24xlarge
      - m6id.2xlarge
      - m6id.32xlarge
      - m6id.4xlarge
      - m6id.8xlarge
      - m6id.large
      - m6id.metal
      - m6idn.12xlarge
      - m6idn.16xlarge
      - m6idn.24xlarge
      - m6idn.2xlarge
      - m6idn.32xlarge
      - m6idn.4xlarge
      - m6idn.8xlarge
      - m6idn.large
      - m6idn.metal
      - m6idn.xlarge
      - m6id.xlarge
      - m6i.large
      - m6i.metal
      - m6in.12xlarge
      - m6in.16xlarge
      - m6in.24xlarge
      - m6in.2xlarge
      - m6in.32xlarge
      - m6in.4xlarge
      - m6in.8xlarge
      - m6in.large
      - m6in.metal
      - m6in.xlarge
      - m6i.xlarge
      - m7a.12xlarge
      - m7a.16xlarge
      - m7a.24xlarge
      - m7a.2xlarge
      - m7a.32xlarge
      - m7a.48xlarge
      - m7a.4xlarge
      - m7a.8xlarge
      - m7a.large
      - m7a.medium
      - m7a.metal-48xl
      - m7a.xlarge
      - m7g.12xlarge
      - m7g.16xlarge
      - m7g.2xlarge
      - m7g.4xlarge
      - m7g.8xlarge
      - m7gd.12xlarge
      - m7gd.16xlarge
      - m7gd.2xlarge
      - m7gd.4xlarge
      - m7gd.8xlarge
      - m7gd.large
      - m7gd.medium
      - m7gd.metal
      - m7gd.xlarge
      - m7g.large
      - m7g.medium
      - m7g.metal
      - m7g.xlarge
      - m7i.12xlarge
      - m7i.16xlarge
      - m7i.24xlarge
      - m7i.2xlarge
      - m7i.48xlarge
      - m7i.4xlarge
      - m7i.8xlarge
      - m7i-flex.12xlarge
      - m7i-flex.16xlarge
      - m7i-flex.2xlarge
      - m7i-flex.4xlarge
      - m7i-flex.8xlarge
      - m7i-flex.large
      - m7i-flex.xlarge
      - m7i.large
      - m7i.metal-24xl
      - m7i.metal-48xl
      - m7i.xlarge
      - m8g.12xlarge
      - m8g.16xlarge
      - m8g.24xlarge
      - m8g.2xlarge
      - m8g.48xlarge
      - m8g.4xlarge
      - m8g.8xlarge
      - m8g.large
      - m8g.medium
      - m8g.metal-24xl
      - m8g.metal-48xl
      - m8g.xlarge
      - mac1.metal
      - mac2.metal
      - p3.16xlarge
      - p3.2xlarge
      - p3.8xlarge
      - p3dn.24xlarge
      - p4d.24xlarge
      - r3.2xlarge
      - r3.4xlarge
      - r3.8xlarge
      - r3.large
      - r3.xlarge
      - r4.16xlarge
      - r4.2xlarge
      - r4.4xlarge
      - r4.8xlarge
      - r4.large
      - r4.xlarge
      - r5.12xlarge
      - r5.16xlarge
      - r5.24xlarge
      - r5.2xlarge
      - r5.4xlarge
      - r5.8xlarge
      - r5a.12xlarge
      - r5a.16xlarge
      - r5a.24xlarge
      - r5a.2xlarge
      - r5a.4xlarge
      - r5a.8xlarge
      - r5ad.12xlarge
      - r5ad.16xlarge
      - r5ad.24xlarge
      - r5ad.2xlarge
      - r5ad.4xlarge
      - r5ad.8xlarge
      - r5ad.large
      - r5ad.xlarge
      - r5a.large
      - r5a.xlarge
      - r5b.12xlarge
      - r5b.16xlarge
      - r5b.24xlarge
      - r5b.2xlarge
      - r5b.4xlarge
      - r5b.8xlarge
      - r5b.large
      - r5b.metal
      - r5b.xlarge
      - r5d.12xlarge
      - r5d.16xlarge
      - r5d.24xlarge
      - r5d.2xlarge
      - r5d.4xlarge
      - r5d.8xlarge
      - r5d.large
      - r5d.metal
      - r5dn.12xlarge
      - r5dn.16xlarge
      - r5dn.24xlarge
      - r5dn.2xlarge
      - r5dn.4xlarge
      - r5dn.8xlarge
      - r5dn.large
      - r5dn.metal
      - r5dn.xlarge
      - r5d.xlarge
      - r5.large
      - r5.metal
      - r5n.12xlarge
      - r5n.16xlarge
      - r5n.24xlarge
      - r5n.2xlarge
      - r5n.4xlarge
      - r5n.8xlarge
      - r5n.large
      - r5n.metal
      - r5n.xlarge
      - r5.xlarge
      - r6a.12xlarge
      - r6a.16xlarge
      - r6a.24xlarge
      - r6a.2xlarge
      - r6a.32xlarge
      - r6a.48xlarge
      - r6a.4xlarge
      - r6a.8xlarge
      - r6a.large
      - r6a.metal
      - r6a.xlarge
      - r6g.12xlarge
      - r6g.16xlarge
      - r6g.2xlarge
      - r6g.4xlarge
      - r6g.8xlarge
      - r6gd.12xlarge
      - r6gd.16xlarge
      - r6gd.2xlarge
      - r6gd.4xlarge
      - r6gd.8xlarge
      - r6gd.large
      - r6gd.medium
      - r6gd.metal
      - r6gd.xlarge
      - r6g.large
      - r6g.medium
      - r6g.metal
      - r6g.xlarge
      - r6i.12xlarge
      - r6i.16xlarge
      - r6i.24xlarge
      - r6i.2xlarge
      - r6i.32xlarge
      - r6i.4xlarge
      - r6i.8xlarge
      - r6id.12xlarge
      - r6id.16xlarge
      - r6id.24xlarge
      - r6id.2xlarge
      - r6id.32xlarge
      - r6id.4xlarge
      - r6id.8xlarge
      - r6id.large
      - r6id.metal
      - r6idn.12xlarge
      - r6idn.16xlarge
      - r6idn.24xlarge
      - r6idn.2xlarge
      - r6idn.32xlarge
      - r6idn.4xlarge
      - r6idn.8xlarge
      - r6idn.large
      - r6idn.metal
      - r6idn.xlarge
      - r6id.xlarge
      - r6i.large
      - r6i.metal
      - r6in.12xlarge
      - r6in.16xlarge
      - r6in.24xlarge
      - r6in.2xlarge
      - r6in.32xlarge
      - r6in.4xlarge
      - r6in.8xlarge
      - r6in.large
      - r6in.metal
      - r6in.xlarge
      - r6i.xlarge
      - r7a.12xlarge
      - r7a.16xlarge
      - r7a.24xlarge
      - r7a.2xlarge
      - r7a.32xlarge
      - r7a.48xlarge
      - r7a.4xlarge
      - r7a.8xlarge
      - r7a.large
      - r7a.medium
      - r7a.metal-48xl
      - r7a.xlarge
      - r7g.12xlarge
      - r7g.16xlarge
      - r7g.2xlarge
      - r7g.4xlarge
      - r7g.8xlarge
      - r7gd.12xlarge
      - r7gd.16xlarge
      - r7gd.2xlarge
      - r7gd.4xlarge
      - r7gd.8xlarge
      - r7gd.large
      - r7gd.medium
      - r7gd.metal
      - r7gd.xlarge
      - r7g.large
      - r7g.medium
      - r7g.metal
      - r7g.xlarge
      - r7i.12xlarge
      - r7i.16xlarge
      - r7i.24xlarge
      - r7i.2xlarge
      - r7i.48xlarge
      - r7i.4xlarge
      - r7i.8xlarge
      - r7i.large
      - r7i.metal-24xl
      - r7i.metal-48xl
      - r7i.xlarge
      - r7iz.12xlarge
      - r7iz.16xlarge
      - r7iz.2xlarge
      - r7iz.32xlarge
      - r7iz.4xlarge
      - r7iz.8xlarge
      - r7iz.large
      - r7iz.metal-16xl
      - r7iz.metal-32xl
      - r7iz.xlarge
      - r8g.12xlarge
      - r8g.16xlarge
      - r8g.24xlarge
      - r8g.2xlarge
      - r8g.48xlarge
      - r8g.4xlarge
      - r8g.8xlarge
      - r8g.large
      - r8g.medium
      - r8g.metal-24xl
      - r8g.metal-48xl
      - r8g.xlarge
      - t1.micro
      - t2.2xlarge
      - t2.large
      - t2.medium
      - t2.micro
      - t2.nano
      - t2.small
      - t2.xlarge
      - t3.2xlarge
      - t3a.2xlarge
      - t3a.large
      - t3a.medium
      - t3a.micro
      - t3a.nano
      - t3a.small
      - t3a.xlarge
      - t3.large
      - t3.medium
      - t3.micro
      - t3.nano
      - t3.small
      - t3.xlarge
      - t4g.2xlarge
      - t4g.large
      - t4g.medium
      - t4g.micro
      - t4g.nano
      - t4g.small
      - t4g.xlarge
      - u-3tb1.56xlarge
      - u-6tb1.112xlarge
      - u-6tb1.56xlarge
      - vt1.24xlarge
      - vt1.3xlarge
      - vt1.6xlarge
      - x1.16xlarge
      - x1.32xlarge
      - x1e.16xlarge
      - x1e.2xlarge
      - x1e.32xlarge
      - x1e.4xlarge
      - x1e.8xlarge
      - x1e.xlarge
      - x2gd.12xlarge
      - x2gd.16xlarge
      - x2gd.2xlarge
      - x2gd.4xlarge
      - x2gd.8xlarge
      - x2gd.large
      - x2gd.medium
      - x2gd.metal
      - x2gd.xlarge
      - x2idn.16xlarge
      - x2idn.24xlarge
      - x2idn.32xlarge
      - x2idn.metal
      - x2iedn.16xlarge
      - x2iedn.24xlarge
      - x2iedn.2xlarge
      - x2iedn.32xlarge
      - x2iedn.4xlarge
      - x2iedn.8xlarge
      - x2iedn.metal
      - x2iedn.xlarge
      - x2iezn.12xlarge
      - x2iezn.2xlarge
      - x2iezn.4xlarge
      - x2iezn.6xlarge
      - x2iezn.8xlarge
      - x2iezn.metal
      - z1d.12xlarge
      - z1d.2xlarge
      - z1d.3xlarge
      - z1d.6xlarge
      - z1d.large
      - z1d.metal
      - z1d.xlarge
    ConstraintDescription: must be a valid EC2 instance type.
  InstanceSpotPriceEnabled:
    Type: String
    Description: Activate or deactivate AWS spot instances type.
    AllowedValues:
      - "true"
      - "false"
    Default: "false"
    ConstraintDescription: must specify true or false.
  InstanceSpotPrice:
    Description: |
      The maximum hourly price to be paid for any Spot Instance launched to fulfill the request. Spot Instances are launched when the price you specify exceeds the current Spot market price.
      You can find more information about the pricing here: https://aws.amazon.com/ec2/spot/pricing/.
    Type: String
    Default: "0.5"
    ConstraintDescription: If the InstanceSpotPriceEnabled variable is true, you must specify the maximum hourly price to be paid.
  KeyName:
    Description: Must be the name of an existing EC2 KeyPair.
    Type: AWS::EC2::KeyPair::KeyName
    MinLength: 1
  SSHSecurityGroup:
    Description: Instances from the specified security group will be allowed to connect using SSH on Cycloid CI workers. Usually you would specify the security group of your bastion server.
    Type: AWS::EC2::SecurityGroup::Id
    MinLength: 1
  MetricsSecGroup:
    Description: Instances from the specified security group will be allowed to read metrics endpoint on Cycloid workers. If you don't have dedicated sec group, simply provide the same as SSHSecurityGroup.
    Type: AWS::EC2::SecurityGroup::Id
    MinLength: 1
  #  SSHLocation:
  #    Description: The IP address range that can be used to SSH to the EC2 instances
  #    Type: String
  #    MinLength: '9'
  #    MaxLength: '18'
  #    Default: 0.0.0.0/0
  #    AllowedPattern: "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})"
  #    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: Must be the VPC Id of an existing Virtual Private Cloud.
    MinLength: 1
  Subnets:
    Type: List<AWS::EC2::Subnet::Id>
    Description: They should be residing in the selected Virtual Private Cloud.
    MinLength: 1
  ScheduledWorkersEnabled:
    Type: String
    Description: Activate or deactivate automatic start / stop scheduling. If true, workers will start and stop at specified time defined in ScheduledWorkersStartRecurrence and ScheduledWorkersStopRecurrence.
    AllowedValues:
      - "true"
      - "false"
    Default: "false"
    ConstraintDescription: must specify true or false.
  ScheduledWorkersStartRecurrence:
    Type: String
    Description: Specifying the recurring StartTime (UTC) for this action, in Unix cron syntax format. For more information about cron syntax, see http://crontab.org/.
    Default: "0 7 * * *"
  ScheduledWorkersStopRecurrence:
    Type: String
    Description: Specifying the recurring EndTime (UTC) for this action, in Unix cron syntax format. For more information about cron syntax, see http://crontab.org/.
    Default: "0 20 * * *"
  OrganizationTag:
    Description: Name of the Cycloid Organization, used as AWS tag
    Type: String
    Default: cycloid
  EnvironmentTag:
    Description: Name of the environment, used as AWS tag
    Type: String
    Default: prod
  RoleTag:
    Description: Name for the worker role, used as AWS tag
    Type: String
    Default: workers
  StackBranch:
    Type: String
    Description: Git branch of the external-worker stack to use (Advanced).
    Default: master
  WorkerVersion:
    Type: String
    Description: Force a specific worker version. Default it will use the version exposed by the scheduler, https://scheduler_api_address/api/v1/info
    Default: ""
  DebugMode:
    Type: String
    Description: Enable of disable debug mode. Debug will ensure the worker keep running even if the initial setub boot script is failing.
    AllowedValues:
      - "true"
      - "false"
    Default: "false"
    ConstraintDescription: must specify true or false.

Mappings:
  # Generate :
  # From https://wiki.debian.org/Cloud/AmazonEC2Image/Bookworm
  # export regions="ap-northeast-1 ap-northeast-2 ap-northeast-3 ap-south-1 ca-central-1 eu-central-1 eu-north-1 eu-south-1 eu-west-1 eu-west-2 eu-west-3 sa-east-1 us-east-1 us-east-2 us-west-1 us-west-2"
  # for region in $regions; do image=$(aws --region $region ec2 describe-images --owners 136693071363 --filters "Name=name,Values=debian-12-amd64-*" "Name=architecture,Values=x86_64" "Name=virtualization-type,Values=hvm" |  jq -r '.Images[] | "\(.CreationDate) \(.ImageId)"' | sort | awk 'END{print $2}'); echo -e "    $region:\n      image: $image"; done
  AWSRegionArch2AMI:
    ap-northeast-1:
      image: ami-02bf7d9fdafa6a866
    ap-northeast-2:
      image: ami-0108cae27cd9cc7af
    ap-northeast-3:
      image: ami-0270e7ced76297c23
    ap-south-1:
      image: ami-0d1d58ce189dfbb25
    ca-central-1:
      image: ami-08ae887d5922c62d9
    eu-central-1:
      image: ami-037808b7c78a7263f
    eu-north-1:
      image: ami-0dbaacd43aeae9663
    eu-south-1:
      image: ami-0dc463d6dfdb4de56
    eu-west-1:
      image: ami-0ae2703824063fcf1
    eu-west-2:
      image: ami-07c6f4cfe050acb11
    eu-west-3:
      image: ami-0a64ca4dc527cbd43
    sa-east-1:
      image: ami-07961f7d701aae8fb
    us-east-1:
      image: ami-0109c48272c1a1186
    us-east-2:
      image: ami-0c631cb6ceaa64bcd
    us-west-1:
      image: ami-07933a20b2bfa7ba5
    us-west-2:
      image: ami-07b2d881c67e4c30e

Conditions:
  EnabledScheduling: !Equals [!Ref ScheduledWorkersEnabled, "true"]
  EnabledSpotInstances: !Equals [!Ref InstanceSpotPriceEnabled, "true"]
  DisabledSpotInstances: !Equals [!Ref InstanceSpotPriceEnabled, "false"]

Resources:
  WorkersRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName:
        Fn::Join:
          - "-"
          - - !Ref AWS::StackName
            - !Ref EnvironmentTag
            - "role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "ec2.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Path: "/"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
      Policies:
        - PolicyName:
            Fn::Join:
              - "-"
              - - !Ref AWS::StackName
                - !Ref EnvironmentTag
                - "ec2-tags"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action: "ec2:DescribeTags"
                Resource: "*"
        - PolicyName:
            Fn::Join:
              - "-"
              - - !Ref AWS::StackName
                - !Ref EnvironmentTag
                - "cf-signals"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action: "cloudformation:SignalResource"
                Resource:
                  Ref: AWS::StackId
        - PolicyName:
            Fn::Join:
              - "-"
              - - !Ref AWS::StackName
                - !Ref EnvironmentTag
                - "cw-logs-push"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "logs:UntagLogGroup"
                  - "logs:TagLogGroup"
                  - "logs:PutRetentionPolicy"
                  - "logs:PutLogEvents"
                  - "logs:DeleteRetentionPolicy"
                  - "logs:CreateLogStream"
                Resource: "arn:aws:logs:*:*:log-group:cycloid-ci-workers_prod:*"
        - PolicyName:
            Fn::Join:
              - "-"
              - - !Ref AWS::StackName
                - !Ref EnvironmentTag
                - "cw-logs"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "logs:ListTagsLogGroup"
                  - "logs:DescribeSubscriptionFilters"
                  - "logs:DescribeMetricFilters"
                  - "logs:DescribeLogStreams"
                  - "logs:DescribeLogGroups"
                  - "logs:TestMetricFilter"
                  - "logs:DescribeResourcePolicies"
                  - "logs:DescribeExportTasks"
                  - "logs:DescribeDestinations"
                  - "logs:CreateLogGroup"
                Resource: "*"

  WorkersInstanceProfile:
    Type: "AWS::IAM::InstanceProfile"
    Properties:
      InstanceProfileName:
        Fn::Join:
          - "-"
          - - !Ref AWS::StackName
            - !Ref EnvironmentTag
            - "instance-profile"
      Path: "/"
      Roles:
        - Ref: "WorkersRole"

  WorkersGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      VPCZoneIdentifier:
        Ref: Subnets
      LaunchTemplate:
        LaunchTemplateId:
          Fn::If:
            - EnabledSpotInstances
            - Ref: LaunchTemplateSpotPrice
            - Ref: LaunchTemplate
        Version:
          Fn::If:
            - EnabledSpotInstances
            - !GetAtt LaunchTemplateSpotPrice.LatestVersionNumber
            - !GetAtt LaunchTemplate.LatestVersionNumber
      DesiredCapacity:
        Ref: NumberOfWorkers
      MinSize:
        Fn::If:
          - EnabledSpotInstances
          - 0
          - Ref: NumberOfWorkers
      MaxSize: 1001
      Tags:
        - Key: "Name"
          Value:
            Fn::Join:
              - "-"
              - - !Ref AWS::StackName
                - !Ref EnvironmentTag
          PropagateAtLaunch: true
        - Key: "role"
          Value:
            Ref: RoleTag
          PropagateAtLaunch: true
        - Key: "cycloid.io"
          Value: "true"
          PropagateAtLaunch: true
        - Key: "project"
          Value:
            Ref: AWS::StackName
          PropagateAtLaunch: true
        - Key: "customer"
          Value:
            Ref: OrganizationTag
          PropagateAtLaunch: true
        - Key: "organization"
          Value:
            Ref: OrganizationTag
          PropagateAtLaunch: true
        - Key: "env"
          Value:
            Ref: EnvironmentTag
          PropagateAtLaunch: true
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
        Count: "1"
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService:
          Fn::If:
            - EnabledSpotInstances
            - 0
            - 1
        MaxBatchSize: "1"
        PauseTime: PT15M
        WaitOnResourceSignals: "true"

  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Condition: DisabledSpotInstances
    Properties:
      LaunchTemplateData:
        KeyName:
          Ref: KeyName
        ImageId:
          Fn::FindInMap:
            - AWSRegionArch2AMI
            - Ref: AWS::Region
            - image
        SecurityGroupIds:
          - Ref: InstanceSecurityGroup
          - Ref: MetricsSecurityGroup
        InstanceType:
          Ref: InstanceType
        IamInstanceProfile:
          Arn: !GetAtt WorkersInstanceProfile.Arn
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeType: gp3
              VolumeSize: "25"
          - DeviceName: "/dev/xvdf"
            Ebs:
              VolumeSize:
                Ref: VolumeSize
              VolumeType: "gp3"
              DeleteOnTermination: "true"
        UserData:
          Fn::Base64:
            Fn::Join:
              - ""
              - - "#!/bin/bash -xe\n"

                - "export PROJECT="
                - Ref: AWS::StackName
                - "\n"

                - "export ENV="
                - Ref: EnvironmentTag
                - "\n"

                - "export ROLE="
                - Ref: RoleTag
                - "\n"

                - "export SCHEDULER_API_ADDRESS='"
                - Ref: SchedulerApiAddress
                - "'\n"

                - "export SCHEDULER_HOST="
                - Ref: SchedulerHost
                - "\n"

                - "export SCHEDULER_PORT="
                - Ref: SchedulerPort
                - "\n"

                - "export TSA_PUBLIC_KEY='"
                - Ref: TsaPublicKey
                - "'\n"

                - "export WORKER_KEY='"
                - Ref: WorkerKey
                - "'\n"

                - "export WORKER_RUNTIME='"
                - Ref: WorkerRuntime
                - "'\n"

                - "export WORKER_TAG='"
                - Ref: WorkerTag
                - "'\n"

                - "export WORKER_DNS_SERVER="
                - Ref: WorkerDnsDerver
                - "\n"

                - "export TEAM_ID="
                - Ref: TeamId
                - "\n"

                - "export STACK_BRANCH="
                - Ref: StackBranch
                - "\n"

                - "export VERSION="
                - Ref: WorkerVersion
                - "\n"

                - "export DEBUG="
                - Ref: DebugMode
                - "\n"

                - |
                  export LOG_FILE="/var/log/user-data.log"
                  exec &> >(tee -a ${LOG_FILE})

                  # Run the startup installation script.
                  # The $RANDOM variable is here used to avoid remote network caching.
                  curl -sSL "https://raw.githubusercontent.com/cycloid-community-catalog/stack-external-worker/${STACK_BRANCH}/extra/startup.sh?${RANDOM}" | bash -s aws

  LaunchTemplateSpotPrice:
    Type: AWS::EC2::LaunchTemplate
    Condition: EnabledSpotInstances
    Properties:
      LaunchTemplateData:
        KeyName:
          Ref: KeyName
        ImageId:
          Fn::FindInMap:
            - AWSRegionArch2AMI
            - Ref: AWS::Region
            - image
        SecurityGroupIds:
          - Ref: InstanceSecurityGroup
          - Ref: MetricsSecurityGroup
        InstanceType:
          Ref: InstanceType
        InstanceMarketOptions:
          MarketType: spot
          SpotOptions:
            SpotInstanceType: "one-time"
            MaxPrice:
              Ref: InstanceSpotPrice
        IamInstanceProfile:
          Arn: !GetAtt WorkersInstanceProfile.Arn
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeType: gp3
              VolumeSize: "25"
          - DeviceName: "/dev/xvdf"
            Ebs:
              VolumeSize:
                Ref: VolumeSize
              VolumeType: "gp3"
              DeleteOnTermination: "true"
        UserData:
          Fn::Base64:
            Fn::Join:
              - ""
              - - "#!/bin/bash -xe\n"

                - "export PROJECT="
                - Ref: AWS::StackName
                - "\n"

                - "export ENV="
                - Ref: EnvironmentTag
                - "\n"

                - "export ROLE="
                - Ref: RoleTag
                - "\n"

                - "export SCHEDULER_API_ADDRESS='"
                - Ref: SchedulerApiAddress
                - "'\n"

                - "export SCHEDULER_HOST="
                - Ref: SchedulerHost
                - "\n"

                - "export SCHEDULER_PORT="
                - Ref: SchedulerPort
                - "\n"

                - "export TSA_PUBLIC_KEY='"
                - Ref: TsaPublicKey
                - "'\n"

                - "export WORKER_KEY='"
                - Ref: WorkerKey
                - "'\n"

                - "export WORKER_RUNTIME='"
                - Ref: WorkerRuntime
                - "'\n"

                - "export WORKER_TAG='"
                - Ref: WorkerTag
                - "'\n"

                - "export WORKER_DNS_SERVER="
                - Ref: WorkerDnsDerver
                - "\n"

                - "export TEAM_ID="
                - Ref: TeamId
                - "\n"

                - "export STACK_BRANCH="
                - Ref: StackBranch
                - "\n"

                - "export VERSION="
                - Ref: WorkerVersion
                - "\n"

                - "export DEBUG="
                - Ref: DebugMode
                - "\n"

                - |
                  export LOG_FILE="/var/log/user-data.log"
                  exec &> >(tee -a ${LOG_FILE})

                  # Run the startup installation script.
                  # The $RANDOM variable is here used to avoid remote network caching.
                  curl -sSL "https://raw.githubusercontent.com/cycloid-community-catalog/stack-external-worker/${STACK_BRANCH}/extra/startup.sh?${RANDOM}" | bash -s aws

  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Worker core security group
      #      SecurityGroupIngress:
      #      - IpProtocol: tcp
      #        FromPort: '22'
      #        ToPort: '22'
      #        SourceSecurityGroupId:
      #          Ref: SSHSecurityGroup
      VpcId:
        Ref: VpcId
      Tags:
        - Key: "Name"
          Value:
            Fn::Join:
              - "-"
              - - !Ref AWS::StackName
                - !Ref EnvironmentTag
                - "instance-sg"
        - Key: "cycloid.io"
          Value: "true"
        - Key: "project"
          Value:
            Ref: AWS::StackName
        - Key: "customer"
          Value:
            Ref: OrganizationTag
        - Key: "organization"
          Value:
            Ref: OrganizationTag
        - Key: "env"
          Value:
            Ref: EnvironmentTag

  # If a SSHSecurity group is provided
  InstanceSecurityGroupSSHRule:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      FromPort: 22
      ToPort: 22
      SourceSecurityGroupId: !Ref SSHSecurityGroup
      GroupId: !GetAtt InstanceSecurityGroup.GroupId

  MetricsSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow metrics server to collect metrics
      VpcId:
        Ref: VpcId
      Tags:
        - Key: "Name"
          Value:
            Fn::Join:
              - "-"
              - - !Ref AWS::StackName
                - !Ref EnvironmentTag
                - "metrics-sg"
        - Key: "cycloid.io"
          Value: "true"
        - Key: "project"
          Value:
            Ref: AWS::StackName
        - Key: "customer"
          Value:
            Ref: OrganizationTag
        - Key: "organization"
          Value:
            Ref: OrganizationTag
        - Key: "env"
          Value:
            Ref: EnvironmentTag

  # If a Metrics security group  group is provided
  MetricsSecurityGroupRule:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      FromPort: 9100
      ToPort: 9100
      SourceSecurityGroupId: !Ref MetricsSecGroup
      GroupId: !GetAtt MetricsSecurityGroup.GroupId

  ScheduledWorkersStop:
    Type: AWS::AutoScaling::ScheduledAction
    Condition: EnabledScheduling
    Properties:
      AutoScalingGroupName:
        Ref: WorkersGroup
      MaxSize: 0
      MinSize: 0
      DesiredCapacity: 0
      Recurrence:
        Ref: ScheduledWorkersStopRecurrence
  ScheduledWorkersStart:
    Type: AWS::AutoScaling::ScheduledAction
    Condition: EnabledScheduling
    Properties:
      AutoScalingGroupName:
        Ref: WorkersGroup
      MaxSize: 1001
      DesiredCapacity:
        Ref: NumberOfWorkers
      MinSize:
        Fn::If:
          - EnabledSpotInstances
          - 0
          - Ref: NumberOfWorkers
      Recurrence:
        Ref: ScheduledWorkersStartRecurrence
